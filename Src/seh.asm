;===============================================================================;
;Макросы, структуры и процедуры для использования SEH в вирусе
;Автор: Bill Prisoner / TPOC 
;Дата последнего обновления: 6.10.2005
;===============================================================================;

SEH struct
	PrevLink dd ?    ; адрес предыдущего SEH-фрейма
	CurrentHandler dd ?    ; адрес обработчика исключений
	SafeOffset dd ?    ; Смещение безопасного места
	PrevEsp dd ?      ; Старое значение esp
	PrevEbp dd ?     ; Старое значение ebp
SEH ends

;===============================================================================;
;Процедура SEHHandler
;Стандартный обработчик исключения для продолжения выполнения с безопасного места
;Вход: не важно, т.к. процедура явно не используется в VDK
;Выход: не важно, т.к. процедура явно не используется в VDK
;===============================================================================;
SEHHandler proc pExcept:DWORD, pFrame:DWORD, pContext:DWORD, pDispatch:DWORD
	mov edx,pFrame
	assume edx:ptr SEH
	mov eax,pContext
	assume eax:ptr CONTEXT
	push [edx].SafeOffset
	pop [eax].regEip
	push [edx].PrevEsp
	pop [eax].regEsp
	push [edx].PrevEbp
	pop [eax].regEbp
	mov eax,ExceptionContinueExecution
	ret
SEHHandler endp
;===============================================================================;


;===============================================================================;
;Макрос CreateSEHFrameEx
;Создает SEH-фрейм. После его вызова начинается код защищенный указанным в параметре обработчиком.
;Если возникает исключение, то управление передается на указанное место параметром Goto.
;Вход: 
;	Goto - куда прыгать, если возникло исключение 
;	Delta - дельта-смещение
;	_EBP - значение регистра ebp после продолжения выполнения с метки Goto
;	_ESP - значение регистра esp после продолжения выполнения с метки Goto
;
;Выход:	ничего
;===============================================================================;
CreateSEHFrameEx macro Goto,Delta,_EBP,_ESP
	assume fs:nothing
	push _EBP
	push _ESP
	push Goto
	mov ebx,Delta
	lea eax,[ebx+SEHHandler]
	push eax
	push FS:[0]
	mov FS:[0],ESP
endm
;===============================================================================;


;===============================================================================;
;Макрос CreateSEHFrame
;Создает SEH-фрейм. После его вызова начинается код защищенный указанным в параметре обработчиком.
;Если возникает исключение, то управление передается на указанное место параметром Goto. В отличие
;от CreateSEHFrame не требует EBP и ESP, а сохраняет текущие. Функция используется, когда 
;значения этих регистров не нужны.
;Вход: 
;	Goto - куда прыгать, если возникло исключение 
;	Delta - дельта-смещение
;
;Выход:	ничего
;===============================================================================;
CreateSEHFrame macro Goto,Delta
	assume fs:nothing
	push ebp
	push esp
	push Goto
	mov ebx,Delta
	lea eax,[ebx+SEHHandler]
	push eax
	push FS:[0]
	mov FS:[0],ESP
endm
;===============================================================================;


;===============================================================================;
;Макрос DeleteSEHFrame
;Используется для восстановления предыдущего SEH-фрейма. Используется в связке
;с CreateSEHFrame и CreateSEHFrameEx. Указатель стека должен быть такой же как и 
;после вызова CreateSEHFrame.
;Вход: ничего
;Выход:	ничего
;===============================================================================;
DeleteSEHFrame macro
	pop FS:[0];Восстанавливаем в FS:[0] адрес предыдущей структуры ERR
	add ESP,16;убираем из стека оставшийся адрес обработчика из структуры
endm
;===============================================================================;